1+. Передалано дерево уставок относительно 168,00,1
2+. Изменен механизм работы Дискретных функций.
3+. ДОбавлена функция Аварийного стопа + исправлена фиксация ошибок. Опять была проблема когда есть две аварии, то после снятия первой, вторая не появлялась. Куда все это девается неясно.
4+. Изменени алгоритм работы UF автоадаптации.
5+. Изменена логика работы квитирования, под новую систему параметров.
6+. Изменена логика работы ПИД. Выбор сигнала ОС ведется через блок КОМБО.
7+. Добавлен механизм проверки светодиодов индикации. LED_CONTROL
8+. ДОработаны спецпараметры для нового дерева. ДОбавлен параметр для проверки светодиодной индикации.
9+. Увеличена частота работы до 400 Гц. Исправлены параметры и пределы - UF, макс. частота, макс. частота в ПИД, Запрещенные частоты.
10+. В ПИД регуляторе исправлен механизм перестройки задания под аналоговые входы - блок FB_COMBO переделан.
11+. Изменена логика работы при заряде звена. Теперь авария Udmin раньше окончания времени заряда не выскакивает. Изменен блок FAIL_COMMON. Добавлена нога сигнала CHARGE. Внимание. у этого сигнала в блоке CP24B будет другая логика работы.
12+. Изменен источник такирования основного процессора.
13+. Изменена логика работы часов.
14+. Добавлен второй вариант автотюнинга на стоячем валу, чтобы использовать реальную индуктивность измеренную.


Версия 168_00_3
1+. Добавлена ссылка на аварию критических частот, когда пусковая частота в зоне критических частот - F_PUSK_FORB - ПРОВЕРИТЬ!
2+. Изменены блоки FORBIDDEN_FREQ & TEMP_LSU_2. Добвалены сигналы по изменению скорости движения в зонах запрещенных частот.
3+. Изменена обработка в блоках FORBIDDEN_FREQ & TEMP_LSU_2 для реализации ускоренного прохождения запрещенных частот. Вариант не самый лучший, видны артефакты в работе. Надо сделать совершенно другой алгоритм. Блок запрещенных частот должен выдавать поэтапные задания, чтобы разгонять двигатель кусочно. До запрещенной частоты своя кривая, в запрещенной частоте своя кривая, и т.д. Иначе будут рывки. Часть из них в режиме ВУ сгладит фильтр, но в скаляре не ясно что будет.

4+ Переделано окружение блока АПВ перегрузка, блока перегрузка двигателя. Теперь отдельно выбирается тип реакции на перегруз двигателя, и отдельно вкл/выкл на АПВ. При включенном АПВ, сразу активирует аварию по перегрузу, даже если она не стояла. Поменял порядок уставок перегруза для АПВ, как они представлены в таблице Лобача.
5+. Переделан алгоритм работы перегруза по токовому интегралу. Диапазон уставки перегруза заявлен 101 ... 200 %
6+. Изменения в блоке Недогруза

7+. В задачу микропрограммы добавлена вычитка серийного номера ПЧ из файла конфигурации и выдача этого номера в систему параметров. Остается его добавить в спецпараметры и вычитывать для создания названия точки доступа. Изменен блок GET_CRC_PO для вывода серийного номера.
8+. Изменения в настройке кривой UF. Заменил названия для Автоадаптации. Теперь есть две типа - пользовательская настройка, и автонастройка на двигатель. Старт идет в режиме автонастройки на двигатель, с автоформированием линейной UF по параметрам двигателя. При попытке изменить любую точку - меняем на пользовательскую форму.
9+. Блок управления механическим тормозом. Блок тормоза работает всегда, а сам выходной сигнал назначаем на реле по необходимости. Полностью реализован и работает.
10+. Изменен блок TEMP_LSU_2 - добавлена выходная нога возбуждения двигателя. По сути маркер, когда работа генератора темпа началась. Сброс сигнала осуществляется только когда ШИМ отключен

11+. Реализация подхвата. Выполнено. ВУ + Скаляр
12+. Устранена проблема коротких импульсов в IGBT
13+. Измерение параметров в скалярном режиме.
14+. Добавлена оценка Lm по таблице токов ХХ.
15+. Добавлены параметры для логера - дискеретные входы/выходы, аналговые входы/выходы.
16+. Переделана логика работы логера - теперь задаем время, тип тригера, и перечень переменных. Остальной расчет идет автоматом.

22-03-21
17+. Исправлена ошибка в работе логера. Теперь после изменения кол-ва переменных графки начинает писаться заново
18+. Открыт доступ в параметрам настройки обрыва связи по WIFI.
19+. Устранен глюк в работе критических частот при задании Ноль. Разрешена работа по каналу задания дискретов, при канале управления НЕ дискреты.
20+. Разделены фиксированные частоты от 1 до 4 при бит коде и номере скорости. там была ошибка в работе.
21+. Заблокирована смена каналов управления и задания через дискрет, когда включен ШИМ. - ПРОВЕРИТЬ!!!! там надо активный канал в статике хранить!?!?!?
22+. Изменена логика в работе тормоза - взята скорость по абс. значению и дабавлена проверка на отключение ШИМа для перезапуска алгоритма.
23+.  U/F заблокирована от смены по дискрету в работе
24+ - АПВ Аналоговые входы
 - на предупреждения отправил неты предупреждения а не аварий.
 - если задано только предупреждение, то обратного отсчета до отключения не будет
 - добавлены все уставки для АПВ аналоговых входов. 
25+. Исправлена ошибка в работе времени фиксации на старте и стопе.
26+. Новый механизм защит минимальной / максимальной частоты
27+. Реализован сброс Причины Остановки по подаче команды Пуск.
28+. Изменена работа аварий/предупреждений Авх.
29+. ДОработаны блоки недогруза и перегруза. Изменена логика отображения предупреждений. Протестированы
30+. Убрал дополнительные единицы измерения у теков Времени АПВ. Погасил именно их единицы измерений. Тексты не менял 
31+. Реализован автоматический перевод в режим работы АВТО, когда включают любое АПВ. Перевод однократный по факту включения любого АПВ. Это даст возможность отключить авторежим через параметр. Режим работы Авто/ручной размещен в FRAM микропрограммы. 
32+. В тестовом режиме изменил типы переменных частоты для нормальной работы с Х_ХХ Гц.  полет нормальный!!!
33+. Авторасчет числа пар полюсов. Работает. Скрыл сам параметр, а открыл номинальную скорость двигателя

34+. Реализован пункт для сброса критических частот и добавлен алгоритм сброса значений на зав. уставки.
35+. авторасчет момента по входным данным двигателя. При восстановлении уставок режим ручной, т.к. там уже должны быть настройки. При работе в авторежим переходим при измении мощности или номинальной скорости.
36+. Исправлено отображение двойных аварий и их смена, а также работа при быстропропадающих авариях.
37+. мигалка при чтении файла ФОПа

38+. Закоротил минимальный момент. Теперь будет только один параметр - максимальный момент на оба ограничения
39+. Авария Udmax и превышение напряжения по входу - изменена логика работы и защелки Udmax. Ошибка сбрасывается с гистерезисом.
40+. Измененил определение для переменной ZERO логера. Были зависания.
41+. Добавлены переводы к переменным логера доступных пользователю.
42+. Исправлена работа блока АПВ. Был баг, при котором просто активное АПВ, при возникновении аварии в стопе, могло вызвать ложное АПВ. Исправлено сбросом времени аварии в системе, если эта авария не была назначена на АПВ.
43+. Временно исправлена работа дискретных функций. Теперь они при деактивации сбрасываются.
44+. Алгоритм измерения параметров двигателя с вращением.

23-04-21
45+. Активирована смена Подхвата в работе. Можно так делать, режим не стартует среди работы.
46+. Реализован механизм предварительной калибровки нуля токового канала при включении ШИМа в блоке СР24В. Теперь измерение параметров работает намного!!! лучше.
47+. Новый алгоритм перегруза - втх.
48+. Реализован вывод постоянного тока в параметры. Исправлен блок расчета Ккоров и формат уставок поменялся.
49+. Исправлено отображение причины останова, при измерении параметров.
50+. Реализовать контроль времени выполнения такта ШИМа и не давать выставлять частоту ШИМа более чем 80% от выполнения такта ШИМа!!! - Сделано, но это работает до первой перезагрузки, либо применится с последующим пересчетом параметров.
51+. Реализован алгоритм фиксации токов при МТЗ компаратора.
52. Расширен диапазон скоростей для модуля WIFI

01-05-2021
53. Исправлен МКАР. Была ошибка при в настройке 2-го аналогового выхода
54. Переделана логика калибровки и работы Авых/Авх для МКАР. Напряжение калибруем по 1В и 10В, ток по 4мА и 20 мА. Работает.
55. Добавлены коэф. регулятора тока.

03-05-2021
56. Добавил разгон возбуждения при подхвате по линейному закону. Изменил LinearRamp - расчет шага приращения проводим на каждом такте, в этом случае разгон выполняется четко за заднное время. И более нет проблемы со скачком тока возбуждения при переходе в ВУ.
57. Исправлена работа СР24 с аналоговыми входами / выходами. Была проблема первичного включения режима 0-10/4-20

07-05-2021
58. ДОбавлены сигналы частоты и периода в измерении параметров, чтобы видеть в теках реальную частоту разгона и ток при измерении Lm c вращением.
59. Добавлен реверсивный расчет момента инерции. ПРоверить и добавить параметр (-) для Кп начального отсчета. - Работает, но странно
60 добавить параметры для подстройки Подхвата. Время на разгон первичного возбуждения, вторичного, разгон момента. Добавить этап стабилизации первичного возбуждения с параметров времени. +++ 
61 добавить уставки на множители ускорения РТ и наблюдателя +++
62 ПРОВЕРИТЬ ИЗМЕРЕНИЕ ПАРАМЕТРОВ - должны быть токи видны и частота на которой что происходит. +++
63--- логика перехода в скаляр из подхвата. - проверить обратный сброс возбуждения к нулю в скаляре и последующее повышение напряжения - Странно себя ведет на 132к
64 - Регулятор Степанова. 
65 - Параметры частоты тормоза задаются в относительных единицах.

14-05-2021
66. Исправлена работа аварии минимальной частоты
67. Исправлена защита по отключению вентиляторов при проблеме с зарядом.
68. Добвалены уставки текущего канала управления и задания, для более точного отображения органов управления в WIFI.
69. ДОбавил обработку внешних блоков, но - на СР24 флэшка не работает нормально. На СР24В не проверил.
70. Добавил новые параметры под динамическое отображение параметров под блок дискретных входов/выходов. Не проверена видимость.
71. Доработан механизм работы с переменной видимость в WIFI.
72. Выполнена полноценная стыковка блоков расширения дискретных входов с ПО. 5 реле и 12 входов.

73. Устранена проблема в работе измерения входного напряжения в блоке МКАР. Инициализация дополнена калибровкой АЦП, и это помогло. Теперь ноль видно нормально.
74. Устранена проблема просадки опоры. Теперь АЦП МТЗ работает всегда, я только включаю прерывания. ПРОВЕРИТЬ!!!
75. Расширен PERIF_V2 для работы с 13-ю дискретами.
76. Добавил первые наработки по переменному ШИМу. Надо проверить наблюдением по цифрологеру Павленко - по анализатору работает нормально.
77. Изменил обработку остаточного времени по перегрузу - тем более 30000 сек не покажу, это будет максимальное время.

78. Исправил глюк в работе  U/F. Стояло ограничение на напряжение в 1. Это нарушает работу на 480 В. Убрал его. Оно там по сути лишнее.
79. Исправлена инверсия в ШИМе Триол. Теперь синхронно с Векторным ШИмом.
80. Реализованы изменения под блок Комбо - входные напряжения и фазировка измеряется правильно.
81. Изменил порядок проверки на МТЗ. Первым поставил компаратор, а то были ошибки при сохранении в журнал.
82. Изменил логику работы U/F. Выходное напряжение не может превышать значение последней точки U/F.

83. Добавил обработку обрыва тормозного резистора и прозвонку двигателя - НО, надо все проверить и добавить параметры в систему для нормальной работы и настройки!!!!
84. Тормозной ключ работает только в работе ШИМа
85. В FAIL_COMMON_V2 добавил еще аварий для отключения заряда.
86. Udmin отрабатываем только при нормально заряженном ЗПТ. в остальных случаях авария будет сброшена
87. Добавил проверку на случай если отключают защиту по входной сети. Мой пример, входной сети нет, а ЗПТ есть. Получаем глюк в расчете уровня Ud заряда.
88. Изменил командоаппарат запуска ПЧ в DRV_V5. Теперь идет перебор всех ситуаций, и если что-то есть, то это отрабатывается.
89. Внешний стоп лифта вешает процессор. Исправлено!
90. Добавлены две вспомогательные уставки к производителю - минимальный уровень работы вентиляторов.
91. Исправлен блок МКАР. Неправильно работала защита для 4-20 канала 1.
92. Добавил в блок DRV_UD данные о защитных уровнях входного напряжения, забрал их из блока DRV_V5. А все данные по напряжениям свести в DRV_UD.
93. Изменена логика отключения/включения заряда. Теперь при наличии аварии отключающей заряд его не будет. Если параллельное есть несколько аварий, то заряд будет если ничто не
    запрещает его из таких авари.
94. Аварии силового ключа работают как МТЗ. Защеликваются на 1 минуту.
95. Добавлена авария Тест резистора не возможен - если отключен тормозной ключ, но включена проверка резистора
96. Добавлена дополнительная задержка в 5000 тактов ШИМа на старте ПЧ по питанию, до начала обработки входной сети. Иначе при ручном квитировании залипает авария Uсети мин.
97. Добавлен триггер для логера - команда Пуска
98. Исправлена ошибка в работе алгоритма прозвонки. Добавлены фильтры на токи. Надо проверить отработку при шумах в токах !!!
99. RAMP_CONTROL_V2 заблокирован для нелифтового использования через Functional??
100. Исправлены две переменные в перегрузе - были U16, а надо было U32 - не хватало разрядной сетки. Добавил обновление счетчика отключения когда нет аварии, иначе новое время не активировалось.
101. Авария двух направлений - МЛЗ.
102-. ДОбавил обработку внешнего контура ограничения по току ПЧ в регуляторе скорости. Ввел уставку максимального перегруза для ПЧ, пока 150% - 37группа. 
      Эта же система подключена к алгоритму Эвакуации и будет ограничивать ток по выходу РС при запитке от резервного источника.
103. Добавил Антиоткат. Надо проверить логику работы в блоке, переключение между коэф., расчет коэффициентов, стыковку с базовым набором.
104. Добавил уставку для времени подъема Предмомента, изменить блок лифта. Изменил формат уставок для Предмомента. Теперь это отдельный класс для Лифта
105-. ИНтегрировал предмомент в регулятор скорости - нужна проверка.
106. Реализован механизм выбора для лифта задания в м/с
107. Переделан обработчик дискретных функций, уставки которые висели раньше в качестве функций, можно убрать. Алгоритмы работают, частично все проверено, лифт, пуск по фронту.  
      Остается уставки удалить и штатно подключить дискретные входы в блок Diskr_Func
108. Реализован механизм перезаписи Функционала в ПЧ в зависимости от выбранного функционала в параметре. Так не придется скрывать лишний раз параметры.
109. Исправлена настройка таймера 5 для пуска АЦП. Он по сути работал в 2 раза чаще чем надо, и давл нам 32 отсчета за такт ШИМа
110. Добавлены: уставка количества допусимых Вайфай подключений, и уставка на сброс пароля Вайфай.
111. Ввел группу функционалов, на 6 функций, для разрешения определенных функционалов.
112-. REF_CONTROL - введен контроль эвакуации, для блокирования сигнала реверса.
113-. Входной сигнал активации Эвакуации смотрим только по старту ПЧ, до 5 секунд, и далее не изменяю.
114+. Изменены названия скоростей в кастомных S-кривых.
115-. В блок эвакуации добавлен сигнал реверса от дискретов для Скалярного режима
116+. Антиоткат - усиление регулятора одним параметром. Просто домножать на него коэфф. в самом регуляторе.
117-. При  аварии, сбрасывать значение предмомента РС. Проверить.
118. Сделал расчет по новым приближенным формулам - Оценка Lm. Плохо стыкуются значения. Отключил. Исправил ошибку в первым варианте. Напряжение брал линейное, а надо фазное.
119. Снижать МТЗ на постоянном токе, на sqrt(2) - Находится в задаче 20 мс.
120. Заблокирована работа с двумя одинаковыми блоками расширения.
121. Блок KOEF_RS исправил. Был неправильный пересчет коэффициентов. Отключил умножение в интеграле, он там не требуется, коэф. работает только в Кп. Сам блок пока не подключен.
122. Поменял местами тим5 и тим2, тогда можно тим1 запускать тим2 ацп!!!
123. Устранил жесткий косяк. В измерении параметров постоянно вызывалось изменение параметров ШИМа, из-за чего скакало время расчета.
124. Разрешил выбор типа управления/задания местный пульт.
125. Исправлена работа в 3к0. АЦП МТЗ все время работает и не сбоит, дергаем только прерывания. Проблема был в самой работе блока. АЦП в останове уже по факту имеет МТЗ при первом же его включении он срабатывает. А при первом пуске в порогах МТЗ стоят 0 и 255 и это не дает ему срабатывать. В останове ставлю в компаратор максимальные его числа и все ОКЭ!
126. Добавлено время разгона в глобал, для передачи в режим измерения параметров с вращением. Теперь время разгона 35 секунд минимум.
127. Исправлена ошибка в работе тормозного ключа. Я его не выключал принудительно в останове.
128. Исправлены пределы нагрузочного регулятора - теперь перегруз тока можно ставить 2х от номинала ПЧ.
129. Доработал алгоритм расшаривания ДМА для блоков расширения и флэшки!!!
130. Доработал ФОП. Исправил частоту Ротора. Поскрывал часть элементов в английском под %.

// Адаптация ПО под работу с блоком СР24 v2.2
131+. Заменил таблицу файлов в FileRDWR чтобы она совпадала с флэшкой Winbond. Проверил работу - полет нормальный.
132+. Частоту кварца выделил как глобальную переменную, т.к. она завязана в паре модулей. В нее задаю частоту кварца в зависимости от блока. Полет нормальный.
133+. Реализован механизм определения типа блока СР24. В зависимости от него ставим тактовую частоту кварца.
134+. Добавил в прерываниях DMA1_Stream5 & DMA1_Stream0 выбор ветки обработки в зависимости от типа блока.
135+. Слоты расширений работают в v2.2 без проблем - оба слота на старых настройках работают без проблем
136+. Выполнил настройку ноги MK_ERR для разных типов блока
137-. Адаптировал динамический выбор ног дискретных входов 1 и 3. Проверить!!!!

138. Переобъявлен семафор ДМА под другим названием. ДОбавлены в СР24 объявления для W25Q16 со своими приставками, прототипы и структуры для SPI4
139. Изменил Стримы ДМА для исключения конфликтов. Переназначил прерывания для ДМА.
140. Адаптировал работу Флэшки в зависимости от типа блока. В 2.1 проблем не выявлено. В 2.2 тоже все работает. Косвенно через WiFi проверил работу - ФОП+уставки. Проблем не вижу.
141. Внес изменения в работу RS-485. В блоке 2.2 обратная логика управления передаче. Прием это 1. А в блоке 2.1 - Передача - это 1.
142. Устранена проблема пусковой частоты, где при Х_ХХ показывало 1,48. Это неточное число было забито исходно в Default.
143. Исправлена работа тормоза с ОС. Неправильно были выбраны режим и дискрет ОС
144. Добавлен новый блок обработки аварий контактора. Теперь при измерении параметров нельзя погасить аварию контактора.
145. ИСправлена работа с 15-м индексом скорости. Реально скоростей 17, а в цикле проверка была для 16 скоростей.
146. Изменение темпа в лифте работает.
147. Исправлена ошибка повторного старта при достартовой прозвонке. Не обнулялся статус командоаппарата ПЧ и Лифт не давал команду пуск.
148. Авария чередования сети может быть если нет дргуих аварий по сети. А текущая фазировка также доступна, если нет аварий по сети.
149. Добавлена авария тормоза - если по факту работы лифта ШИМ отключен а тормоз не наложен.
150. Исправлена проблема прерывания измерения параметров в Лифте. Надо было при отключении проверять еще флаг измерения параметров, перед отключением контактора.
151. Изменена логика работы механизма блокировка пуска без скорости. Введены режимы - Откл, предупреждение, авария. Из DISK_FUNC выдает сигнал о наличии скорости при активном задании по дискретному входу. Сигнал заводится в блок PUSKов и там уже выполняется блокировка с формированием аварий и предупреждений. 
152. Исправлена проблема ложного пуска при смене макросов в пульте. При неправильном режиме управления по дискретам, я перезапоминаю состояние дискретных входов, до получения нормальной схемы управления
153. Для лифта ставлю ограничение момента равным 3х от номинала ВСЕГДА. А основное ограничение делаем по контуру активного тока в автоматическом режиме. Уровень перегруза по полному току частотника привязываем к уставке МТЗ - не более 80%, и исходя из реактивного тока получаем максимальный активный ток.
154. ДОбавлены новые графики логера в список - сигналы с дискретного блока расширения.
155. ДОбавил в штатный коэф. для коррекции возбуждения при генераторном режиме.
156. Исправил работу такта ШИМа в аварии. Снова в измерении параметров была ситуация, когда шла постоянная переинициализация на 4 кГц.
157. Сделано ограничение максимального тока DC на уровне, не превышающем 80%/1,414 от МТЗ.
158. Отключен доступ к функционалу Перегруза когда у меня активен ЛИФТ.
159. Скрыта часть защит по сети и АПВ которые не доступны для СР24.
160. Добавлен отдельный блок функционала - который будет определять - доступна функция или нет. Все что запрещено будет сброшено в базовый насос.
161. Уставку номинального напряжения двигателя привязал к базе по напряжению с запасом ~ 1.26 (380 база, а максимум 480 можноы).
162. Снова доработка дискретных пусков. Изменил шаблоны запуска трехпроводного управления. Были проблемы с пуском по спаду, и при изменениях назначений были самопроизвольные пуски при замкнутых дискретах. Также исправил работу урезанных трехпроводных схем.
163. Доп.ограничение тока торможения ПТ - максимальный предел не более 300 %. Установлен в DRV_V5
164. Исправлена работа перегруза в режиме время-ток.
165. Отладил работу системы восстановления уставок при смене микропрограммы. Можно использовать.
166. Добавлен механизм восстановления паролей из ФРАМ. Сброс в дефаулты выполняется автоматически сам собой при замыкании джампера
167. Восстановлена работа проверки тормозного резистора и антиотката  версии блока СР24.
168. Добавлена блокировка двух блоков расширения в СР24.
169. Исправлен алгоритм пуска по подаче питания. Из-за переноса AUTO_MODE into FRAM при инициализации автозапуска еще авторежим не установлен. Первый такт сделал только для FirstCall. А потом уже делаем проверку на автозапуск.
170. Исправил Хэлп по антиоткату.
171. Изменена уставка ТЕК для текущего задания ПИД регулятора. Теперь она в переменных единицах относительно ОС Авх.
172. Исправлена обработка множества аварий. Теперь если последоватально приходят несколько аварий, то они все будет отображаться до устранения.
173. Сделал блокирование сброса калибровок в 1 при сбросе на дефаулт через джампер. Добавил обход локально для калибровок тока и напряжений.
174. Немного почистил DisCR_FUNC. Убрал лишние уставки и ссылки на них. Подключил входы дискретных назначений к блоку и внес изменения в код по их чтению и обработке.
175. Исправлен алгоритм восстановления уставок. Была ошибка. Брал не оттуда копию значений уставок.
176. Реализован новый блок обработки предупреждений. Пока выполнена замена старого блока. Теперь надо реализовать свою задумку.
177. Cделал защиту от сброса на дефаулт по джамперу, когда ПЧ в ШИМе.
178. Сделал защелкивание предупреждений. Внес изменения в блок дискретных сигналов и вывел первое предупреждение."Дискретная функция уже назначен"
179. Убрал пока уставки выбора по ДИН канала задания и управления. Добавил виртуальные функции и перекинул на них управление. Все работает.
180. Завершил реализацию уставок двойников для Дискретных функций. Параллельность работает. Уставки храним в FRAM. Пока все ОК!
181. Реализовал алгоритмы восстановления калибровок при сдвинутом адреса калибровок. Это костыль, а нужна авария для блокирования такой ситуации на стадии тестирования. аходится в BASE_CALC!!
182. Для СР24/CP24B сделал идентификацию блоков расширения по старту. Далее блоки не проверяются.
183. Добавлены изменения Коцюра по работе с блоками расширения через МКАР. Добавлен Din.
184. Внесены изменения в блок Perif_V2, добавлены ноги для Авых3/4. Добавлены уставки для Авх3/4 и Авых3/4 (частично, там еще надо назначение доделать)
185. Реализовал ЗИ типа Sin2.
17-10-2021
186. Переделал в СР24В подключение внешних блоков. Прикурил блок Ethernet. Все работает хорошо. Но за блоком надо понаблюдать, иногда у него есть сбои с подключением по Ethernet - его не видно внешнним устройством.
18-10-2021
187. Добавил адрес из RS-485 для всех внешних блоков расширения.
188. Актуализировал уставки для энкодера, добавил внешние уставки для фазы и скорости энкодера.
19-10-2021
189. Добавлен регулятор потока для ослабления поля. Полет нормальный
	21-10-2021
190. Исправил проблему измерения параметров. Неправильное значение было у времени Ts фильтра логарифма и все он портил.
191. Сделал мертвое время дискретизации при измерении параметров без вращения.
192. Исправлена работа в СР24 блоков расширения и работа с Флэш. Сейчас работает нормально. Но блок Ethernet еще не подключен. Пульт не должен ощутить проблем при подключении к ПЧ в работе.
193. Внесена правка видимости для ПО МКАР - теперь ее надо отображать только для СР24В. Проверит в Вайфай!!!
194. Изменил расчет переменных прореживания extDataSendSkip1 и extDataSendSkip2 - изменил формат задания на секунды
195. Проверка ошибок на приеме длинных пакетов по уарт. Когда возникает ошибка в ДМА и УАРТ, идет остановка ДМА и перезапуск UARTa. С пакетами более 256 байт перезапуск работает нормально.
196. Добавлены ТРИ файла в систему - шрифты OP24B, Прошивка МКАР, прошивка пульта OP24S.
	28-10-2021
197. Исправлена ошибка сброса настроек дискретов при переключении между авто и ручным режимом.
	29-10-2021
198. Добавил восстановление значения цифрового потенциометра после подачи питания. Пока это только ТЕК параметр.
199. Переделал вид цифрового потенциометра. Реализовал его в процентах и вывел в два места - на задание частоты (идет в относительной частоте) и для задания ПИДа (идет в процентах). Для нормального вывода задания ПИДа изменил блок PID_REF_CONVERT, чтобы он из процентов сделал пересчет в диапазон ОС.
200. Доработан Блок FB_COMBO. Добавлено предупреждение, в случае выбора Авх3/4 когда нет блока расширения.
201. Немного доработал стыковку с блоком RS2. Теперь к нему отправляются его настройки. И добавил прореживание в 0,5 сек для его долбления.
202. Предварительно добавил уставки напряжения в аварийный журнал.
203. Скрыты из видимости старые уставки цифрового потенциометра. 13-01 + 13-02
204. Добавлена и проверена авария при неправильном адресе калибровок (0x7f94)
205. Небольшие изменения по блоку DIN_UP_DOWN, чтобы в Флоате погрешности не вылазили. 
206. Изменен блок apv1 - реализован дополнительный сброс счетчиков АПВ, когда произошел пуск. Также добавлен сброс кол-ва АПВ если ПЧ нормально после АПВ отработал сутки. Здесь надо исправить, и вместо жестких суток добавить уставку.

	05-11-2021
207. Исправлена ошибка для блоков CP24 v2.2. Неправильное задание тактовой частоты процы. Не учел множитель 360. Для 12 Мгц он должен быть 300.
208. Вероятно, была ошибка при формировании журнала аварий. Я не переместил данные по напряжению в такте ШИМа в журнальную часть.
209. Добавил в UC проверку на превышение Udmax выше, чем юстировочное
210. Добавлена защита от нулевого напряжения в скаляре, при отработке аварии обрыва нагрузки. В этой ситуации, при нулевом напряжении авария блокируется.ы
211. Запускал новый блок СР24 2.2 и выявил проблему. ПЧ как бы в готовности, но готовность не горит, т.к. при вычитке данных о АПВ есть некий глюк. Для этого добавил CRC к данным, чтобы защититься от такой ситуации. Это обнуляет блок сохраненных данныъ если CRC не совпал.

	10-11-2021
212. Журнальные данные по напряжениям разместил на уст. 30-14, 30-15, 30-16. Текущий статус перенес в 25 группу к текущим значениям.
213. исправления блока Perif для нормальной работы AIO2.
214. Доработа драйвера UART в обоих блоках СР24 и СР24В под блок RS2. На большом все ок, малыша еще надо проверять.
215. Подтяжка аналоговых входов 3 и 4. В задание частоты добавлены Авх 3 и 4. Назначение Авых добавлены Авх 3 и 4. Источник задания ПИД добавлены Авх3/4. 
216. ДОбавлена Авх 3/4 и Авых 3/4 на логер. Исправлена ошибка вывода Авх/Авых на логер. Похоже в СР24В вообще ничего не выводилось, а в СР24 Выходы не выводились. Провтыкал.
217. Добавлена блокировка назначения одинаковых адресов для RS2. Сделано предупреждение для этого режима.
218. Исправил видимость уставки Текущее задание частоты. 
219. Добавил возможность видеть текущее задание ПИД (20-22), если задание приходит от аналогов или цифрового потенциометра, то там будет относительное значение в процентах. Надо попробовать сделать чтобы в значениях ОС ПИД показывалось

	16-11-2021
220. Добавлены параметры состояния Аналоговых входов - Авх. Состояние. Дублируем состояние - Норма, ХХ, КЗ.
221. Задание ПИДа для любого формата ввода пересчитывается к типу ОС, и показывается просто отлично, а не просто в процентах!!
222. Добавлены отдельные команды Запрет пуска и разрешение пуска. Запрет пуска - по аналогии с внешней блокировкой. Разрешение пуска - если сигнал есть, то пуски будут проходить. Иначе при подаче пуска будет его блокировка с формированием предупреждения.
223. Сделал индикацию для автозапуска по подаче питания - мигает как в АПВ желтый и мигает предупреждение. Если в это время нажать стоп, то автозапуск сбросится.
224. Добавил в MainControl, FailControl- дополнительные повторные стопы ШИМа при аварии и выключенном ШИМе. 
225. Добавлена доп. защита по Udmax. Еще сравниваю значение АЦП. Оно не должно превышать 98% от всей шкалы. Выходит где-то 4015 единиц.
226. Исправлен расчет числа пар полюсов. Выявлена проблема для синхронных двигателей.
227. Добавлена проверка в драйвере ШИМа, чтобы значения Ta, Tb, Tc не превышали 1.
228. Добавлено разрешение для uartExt1 & uartExt2 управлять по АСУ при пеедаче команды 0х05. Подвязка сделана в PORT_UART_3 от uart1

	27-11-2021
229. Сделал постоянный сброс в состояние Отключено режим измерения параметров. Параметр энергозависимый, так вот его значение по старту всегда принимается равным уставке после сброса на заводские и пользовательские настройки. Очень интересный эффект.
230. Добавлено предупреждение при переходе в режим эвакуации.


	04-12-2021
231. Реализована совместимость работы блока МКАР старого и нового с новый версией 168.51.2.
232. Переформатировано расположение файлов в системе. Изменено назначение файлов цветного и чб пульта. Добавлена секция для архивного ФОПа.
233. ДОбавил проверку обработки аварии ключей в стопе и не только по фронту. Но нужна проверка на приводах.
234. Исправлена ошибка в работе алгоритма обрыва нагрузки. После ввода исключения по нулевому напряжению в скаляре. Я просто отключил проверку обрыва в режиме ВУ.
235. Для скалярного режима при старте задается фиксированная фаза поля = 180 градусов. Необходима проверка на постоянном токе.
236. ОТКАТИЛ НАЗАД РАБОТУ С КЛЮЧАМИ - ТОЛЬКО ПО ФРОНТУ для РВ24
     Версия сдана в БТД 07-12-21 

	09-12-2021 - пункты можно добавлять в новую версию ПО и ТЗ 168,51,3
237. Добавил алгоритм измерения параметров на низкой частоте. То что раньше было в лифте.
238. Изменил величину фильтра нулевого значения для блока СР24, иначе при первому пуске возникает дополнительное смещение нуля, а при повторных уже нормально.
239. Сделал динамическое отображение параметров энкодера в зависимости от типа блока на схеме. Лишнее скрываю.
240. В MakeOpis сделан алгоритм анализа энергозависимый параметр или нет. Для энергозависимых параметров значение при пуске сбрасываю в ноль. Это как бы логично
241. Убрал в блоке DRV_V5 ногу 7, которая также читала тип управления. Теперь работает только нога 35.
242. Изменил работу Цифрового потенциометра. Добавил механизм выбора режима - сохранять задание или сброс в ноль в останове. Добавил уставку для предустановки задания в режиме сохранения задания.
243. Добавил в 10 группу резервные уставки для заполнения пустот.
244. Исправлена ошибка установки отрицательных значений уставок. Проблема была в MakeOpis.
245. Добавлены режимы регулятора фазы потока. Фиксированный режим и режим ПИД регулятора.
246. Исправлена ошибка в доступе к параметрам uns32Fmt - для данного типа не була указана маска получения 4 байт.
247. Исправлена ошибка при измерении параметров от дискретов. Была ошибка в дискр.функциях - прилетал ложный стоп. Не учел в условии фиксации предыдущих значение флаг измерения параметров.
248. Сделан синхронизацию файлов DK_file. Через CRC не получилось, сделал метку на ноль времени UNIXTIME. После переноса нужной секции обнуляю старый DK_file
249. Запрещена работа двух блоков энкодеров - может быть только 1 блок энкодера. Порядок активации блоков Слот1->Слот2->Слот3
250. Исправлена ошибка в конфигурировании эмулятора энкодера. В блок ЭНКО не передавлся режим работы эмулятора.
251. Исправлена ошибка при выводе скорости энкодера в скалярном режиме.
252. Параметр 10-00 - Единицы частоты/скорости, скрыт для Лифта.
253. Исправил работу тормоза лифта. Убрал ошибку работы когда режим Тормоза - Отключен. Возниикала ложная авария, что Шим отключен при снятом тормозе.
254. Устранена проблема в кратком нажатии пуска при включенной проверке тормозного резистора. В Case LiftStopped добавлено условие завершения работы Стопа, только по окончании работы командоаппарата DRV.
255. Изменены тексты аварий контактора. В остальном они выдают правильные сигналы
256. Изменена работа блоков энкодера. Изменены тексты для Endat энкодеров. часть уставок скрыта у не нужных блоков. 
257. Реализован новый алгоритм контроля обрыва нагрузки. Работает на нижнем уровне. Смотрит за трехфазным током и находит его фазу. Если есть обрыв одной фазы то, вектор фазы начинает метаться между двумя положениями. Обрыв фиксируется по факту неизменения фазы, от ожидаемой. Сигнал обрыва передается в Микропрограмму и там в штатном модуле активирует ее. Авария работает на частоте выше 0,2 Гц. На постоянном токе все равно необходимо контролировать мгновенные токи по старому алгоритму.
258. В штатный алгоритм контроля обрыва нагрузки внес изменения. Внес алгоритм изменения времени наблюдения при частотах выше 10 Гц. Время наблюдения будет составлять 5 периодов текущей частоты. Кроме того, если я вижу что есть обрыв трех фаз (для этого нахожу среднее значение абсолютных токов), то счетчик тикает в 3 раза быстрее.
259. Ослабление поля перенес в группу Векторное управление
260. Добавил уставку расчета коэф. регулятора фазы потока в автоматическом режиме. Как и завещал Шипулин.
// Сделан комит

07-01-2022
261. Добавил новую обработку АПВ но пока с ней проблемы.
262. Выявлена ошибка ложного предупреждения о старте по подаче питания. Устранил доп. условием.
263. Добавил правку в расчет Дедетайма ото частоты ШИМа. Так себе решение, но проверим на лифте.
264. Исправлена ошибка в работе регулятора фазы потока. Была проблема в работе на отрицательных частотах вращения. Регулятор неправлиьно компенсировал фазы, не в ту сторону.
265. Нашел ошибку при работе с переменным ШИМом. Проблема, была в сбое таймера, он успевал перескочить через точку сравнения и более не срабатывал пока не проходил через ноль. Сделал его обнулялку и все исчезло.
266. Добавил дополнительно проверку активации переменного ШИМе на постоянном токе в случае перехода в режим торможения постоянным током. Флаг активации торможения ПТ выставляю в  DRV_V5 и только для асинхрронников.
267. Добавил нормальную уставку на время плавного сброса тока.
268. Реализованы новые методы компенсации дедтайма. Сделан параметр для выбора режима. Также надо указывать параметры ключей.
269. Завершена разработка алгоритмов измерения параметров двигателя PMSM. Проверено - работает корректно.
// Сделан Комит

10-02-2022
270. Исправлена работа плавного сброса тока. В коммандоаппарате стопа была ошибка, процесс зацикливался.
271. Добавил пересчет момента в ток, для синхронной лебедки.
272. Добавлен режим симуляции токов и напряжений в приводе. Первый тестовый вариант.
273. Добавлены уставки для управления сменой частоты ШИМа на частотах НИЖЕ 1 Гц. Не на нуле, а все таки ниже 1 Гц.
274. В модули dtc я передаю ЗПТ фильтрованное.
275. Реализован алгоритм адаптивного выбора режима предмомента. Есть выбор - или чисто активный ток, или смешанный - после пуска идет примагничение, а потом после захвата активного тока включается предмомент. Вместе не работают. Оба алгоритма живут в Предмоменте
276. Переделан алгоритм смены ШИМа через пропуск такта управления и заменой его на пересчет параметров. Все работает корректно.

25-03-2022 - спустя месяц войны!
277. Добавил немного элементов для симуляции. Активировал дефайном _PROJECT_FOR_VS2005_ разрешение пересчета напряжений и токов в CalibrFunk()/DRV_V5.h. Реализовал чтение дискретных входов в Perif_V2, теперь можно управлять по дискретам. Пока использую старые переменные симуляции. Напряжение ЗПТ и входная сеть формируются нормально. Пуск с дискрета по инверсии идет отлично. В PORT_UART_3 внес правку для получения команды пуска по Модбасу 0х05 функцией, почему-то пришлось снова внести изменения. Сформировал выходное напряжение в скаляре. Добавил расчет токов в обмотках в зависимости от параметров двигателя, частоты вращения и напряжения на выходе. Добавил симуляцию фазы (со случайной установкой начальной фазы) и скорости энкодера, также добавил установку наличия блока энкодера, и иммитацию сигнала R метки. Этого в целом хватает для текущей проверки алгоритма фазирования. 
278. В DRV_V5 убрал отдельный дефайн для вывода текущей частоты в режиме симуляции в VS2005. В блоке симуляции отдельно есть замена, так что ниже по коду она лишняя уже.
279. Реализация алгоритма фазирования энкодера. В целом корректая часть работы фазировки энкодера работает для обоих режимом - 1 и 2 такта. Также проверены две аварии обработки. Остальные аварии необходимо проверить и реализовать.
280. Доделал сохранение уставок при фазировке через микропрограмму. Но надо проверять в железе.
281. Изменил блок фазировки - добавил новые сигналы для нормальной работы. Убрал использование AllPrmPnt.
282. Добавлен низкоуровневый алгоритм для фазировки энкодера в PMSM_Antirollback - запускается по сигналу фазировки. Выполняет плавный подъем тока и вращение поля с контролем уровня тока. Проверил сам алгоритм в симуляции.
283. В Diskr_Func в момент стартовой подгрузки назначений сигналов добавил проверку - если назначение выходит за диапазоны в таблице назначений, то я его обнуляю.
284. Поправил ряд делений на ноль в симуляции (блоки расширений, DRV_UD)
285. Добавлена уставка тока удержания кабины в режиме фазирования энкодера. 
286. Исправлены форматы отображения для параметров фазировки энкодера - теперь они будут видны только при наличии блока энкодера.
287. Доработан командоаппарат лифта, реализован дополнительный этап фазирования энкодера. Обходим режим предмомента и работаем в фазировке. В данном случае это больше касается PMSM, т.к. там сейчас на нижнем уровне сделан свой алгоритм движения кабины.
288. Сделал механизм дополнительной видимости уставок настройки авариий для блоков RS2. Если вдруг защита по связи активна, а блока нет, то при возникновении аварии будет разрешено показать две уставки настройки аварий связи блока RS2. ПОсле отключения аварий, уставки самоскроются )
289. В  VS2005 реализован механизм создания файлов зав.уставок  в ходе симуляции (он по факту и так работал) и сделан механизм подгрузки готового файла уставок через иконку "солнышка" рядом со смайликом. Если выбран файл dtu то в симуляции мы грузим в систему новый шаблон зав. уставок. В конце сообщение от логгера - тут ничего пока не сделаю. Но для активации надо все же полностью перезапускать проект. Пока только так. 
290. Реализовано неприоритетное предупреждение при работе в режиме симулятора токов. Для больше безопасности.
291. Исправил ошибку в настройке Din5. Где-то возник сбой в порядке инициализации, в результате чего флэшка стала позже инициализироваться. А в настройках FLASH_RES_MK_GPIO_Port был указан неправильный порт управления. Исправил при помощи блокировки настроек ПИНа HAL_GPIO_LockPin.
292. Исправлен странный баг в температуре, свяазанный с определением блока. Где-то начало проявляться позднее определение блока, что приводило к неправильному начальному расчету температуры. В блок Temp_Control добавлено исключение если блок не определен, то сразу выхожу из расчета температуры.
293. Реализовано предупреждение по факту окончания фазирования энкодера.
294. Изменил пределы выбора для настройки тормоза - теперь его нельзя отключить. Иначе могут быть проблемы в работе. Его сигнал часто используется в системе как триггер.
295. В алгоритме переменной частоты добавил две защиты от ограничения частоты ШИМа - минимум и максимум.

08-04-2022
296. Добавлены в дискретные функции две пользовательских аварии: Авария пользователя 1 и 2.
297. Предварительно исправлена работа генератора темпа sin2. При равенстве задания пусковой частоте (не нулевое) возникала ошибка расчета кривой разгона. Добавил проверку на ноль перед вызовом функции расчета.
298. Исправлена работа генератора темпа. Теперь задержка удержания на пусковой частоте будет отрабатываться только при пуске или при стопе. При снижении к частоте пуска в рабочем виде, удержания на пуске не будет, а значит задание скорости может меняться сразу, без лага.
299. Для реализации гибкого переключения между разным входным напряжением Udmax и Udmax заряд сделаны абсолютными значениями, и устанавливаются в соответствии с предельными значениями ЗПТ (тип S16). В тоже время Udmin остается относительно базы по напряжению (S32/Float). Поэтому из блока DRV_UD выходит два доп.NETa. Один выдает относительную величину Udmax, а второй абсолютное значение Udmin для корректной работы уставок по ограничениям. Поэтому теперь уставки надо набивать при напряжении 380В, т.к. там будет формироваться величина Udmin. Остальным будет все равно.



============================================================================================================================================
блок СР24
ДМА

DMA1_Stream0 - USART5_RxHdma/hdma_spi3_rx (2.1) /  USART5_RxHdma(2.2)
DMA1_Stream1 - hdma_usart3_rx
DMA1_Stream3 - hdma_usart3_tx
DMA1_Stream5 - USART2_RxHdma/hdma_spi3_tx (2.1) / USART2_RxHdma (2.2)
DMA1_Stream6 - USART2_TxHdma
DMA1_Stream7 - USART5_TxHdma


+DMA2_Stream0 - hdma_adc3
+DMA2_Stream1 - hdma_spi4_tx
+DMA2_Stream2 - hdma_usart6_rx ++
+DMA2_Stream3 - hdma_spi4_rx
+DMA2_Stream4 - hdma_adc1
+DMA2_Stream5 - hdma_usart1_rx ++   !!!!!
+DMA2_Stream6 - hdma_usart6_tx
+DMA2_Stream7 - hdma_usart1_tx      !!!!!

--------------------------
168.00.3 / 168.50.2
СР24 2.2
DIN_HF_MK (PD3) в новой плате заводится на 2 вывода: PD3 и PA15.
Дублирование сделано для возможности реализовать в ПЧ внешний стоп (СТО), а также измеритель частоты как обычный быстрый вход. 


// Доработка  для Лифта
1. Не устанавливается режим контактора с ОС
2. Не переключаешься на UF1 по умолчанию
Общее изменение
3. ПО МКАР в статистике надо сделатьс переменной видимостью
4. Журнал по напряжениям
5. По нажатию на кнопку ОБновить - надо сдвигать экран, чтобы было видно что событие произошло. А то иногда нажал, а ничего не происходит.
6. Надо сделать обработку текстовых элементов еще по одному признаку - #. После # указываем номер блока расширения как у нас объявлено. Если в системе есть такой блок - показываем доступный перечень выпадающего списка. По аналогии как с Функционалом.
7. ОШибка в работе с 


UART0 - RS485 -> USART1
UART6 - Pult  -> USART6  DM13Y
UART2 - WIFI  -> USART3
USART5 - EXT1
USART2 - EXT2
*******************************************************
CP24B NVIC priority
HAL_NVIC_SetPriorityGrouping(NVIC_PRIORITYGROUP_4); - HAL_init     VIC_PRIORITYGROUP_4        /*!< 4 bits for pre-emption priority, 0 bits for subpriority */


HAL_NVIC_SetPriority(ADC_IRQn, 1, 0);					1
HAL_NVIC_SetPriority(EXTI4_IRQn, 1, 0);      // STO + Аварии ключей 	2
HAL_NVIC_SetPriority(EXTI9_5_IRQn, 1, 0);    // STO + Аварии ключей	3
HAL_NVIC_SetPriority(EXTI15_10_IRQn, 1, 0);  // STO + Аварии ключей	4

HAL_NVIC_SetPriority(TIM1_CC_IRQn, 5, 0);    // ШИМ			5
HAL_NVIC_SetPriority(TIM8_TRG_COM_TIM14_IRQn, 5, 0); // MICRO		6

HAL_NVIC_SetPriority(DMA1_Stream4_IRQn, 8, 0); // МКАР			7
HAL_NVIC_SetPriority(DMA1_Stream2_IRQn, 8, 0); // МКАР			7

HAL_NVIC_SetPriority(DMA2_Stream3_IRQn, 8, 0);  // SPI4 - AT45		8
HAL_NVIC_SetPriority(DMA2_Stream1_IRQn, 8, 0);  // SPI4 - AT45		8

HAL_NVIC_SetPriority(DMA1_Stream1_IRQn, 8, 0); // DMA UART пульта, 	9
HAL_NVIC_SetPriority(DMA1_Stream3_IRQn, 8, 0); // вайфай, 485		9
HAL_NVIC_SetPriority(DMA2_Stream2_IRQn, 8, 0);				9
HAL_NVIC_SetPriority(DMA2_Stream6_IRQn, 8, 0);				9
HAL_NVIC_SetPriority(DMA2_Stream7_IRQn, 8, 0);				9
HAL_NVIC_SetPriority(DMA2_Stream5_IRQn, 8, 0);				9

HAL_NVIC_SetPriority(USART1_IRQn, 8, 0);	// USART1		9
HAL_NVIC_SetPriority(USART3_IRQn, 8, 0);	// USART3		9
HAL_NVIC_SetPriority(USART6_IRQn, 8, 0);	// USART6		9
HAL_NVIC_SetPriority(USART2_IRQn, 8, 0);	// USART2		9
HAL_NVIC_SetPriority(UART5_IRQn,  8, 0);	// UART5		9

HAL_NVIC_SetPriority(DMA1_Stream6_IRQn, 8, 0);  // DMA USART2 EXT2	9
HAL_NVIC_SetPriority(DMA1_Stream5_IRQn, 8, 0);  // DMA USART2		9
HAL_NVIC_SetPriority(DMA1_Stream7_IRQn, 8, 0);  // DMA USART5 EXT1	9
HAL_NVIC_SetPriority(DMA1_Stream0_IRQn, 8, 0);  // DMA USART5		9

HAL_NVIC_SetPriority(DMA2_Stream4_IRQn, 13, 0); // hdma_adc1
HAL_NVIC_SetPriority(DMA2_Stream0_IRQn, 14, 0); // hdma_adc3
HAL_NVIC_SetPriority(PendSV_IRQn, 15, 0);	// HAL_MspInit()
*******************************************************
CP24 NVIC priority
HAL_NVIC_SetPriorityGrouping(NVIC_PRIORITYGROUP_4); - HAL_init     VIC_PRIORITYGROUP_4        /*!< 4 bits for pre-emption priority, 0 bits for subpriority */



  // 2) Установить приоритет прерывания в зависимости от режима
  if(p->ModeComp == CompWaitErr){                 // Отключение по переднему фронту
     HAL_NVIC_SetPriority(EXTI9_5_IRQn, 1, 0);    // Приоритет как у МТЗ
  }
  else if(p->ModeComp == CompCountFront){         // Считаем количество импульсов
     HAL_NVIC_SetPriority(EXTI9_5_IRQn, 10, 0);   // Прерывания в фоне
  }
  else if((p->ModeComp == CompErr)||(p->ModeComp == CompOff)){
     HAL_NVIC_SetPriority(EXTI9_5_IRQn, 10, 0);   // 

HAL_NVIC_SetPriority(TIM8_TRG_COM_TIM14_IRQn, 5, 0); // MICRO

HAL_NVIC_SetPriority(DMA1_Stream5_IRQn, 8, 0); // SPI3 AT45
HAL_NVIC_SetPriority(DMA1_Stream0_IRQn, 8, 0); // SPI3 AT45

HAL_NVIC_SetPriority(DMA2_Stream3_IRQn, 8, 0); // SPI4 W25Q16 
HAL_NVIC_SetPriority(DMA2_Stream1_IRQn, 8, 0); // SPI4 W25Q16

HAL_NVIC_SetPriority(DMA1_Stream1_IRQn, 8, 0); // DMA UART пульта, вайфай, 485
HAL_NVIC_SetPriority(DMA1_Stream3_IRQn, 8, 0);
HAL_NVIC_SetPriority(DMA2_Stream2_IRQn, 8, 0);
HAL_NVIC_SetPriority(DMA2_Stream6_IRQn, 8, 0);
HAL_NVIC_SetPriority(DMA2_Stream7_IRQn, 8, 0);
HAL_NVIC_SetPriority(DMA2_Stream5_IRQn, 8, 0);

HAL_NVIC_SetPriority(USART1_IRQn, 8, 0);	// USART1
HAL_NVIC_SetPriority(USART3_IRQn, 8, 0);	// USART3
HAL_NVIC_SetPriority(USART6_IRQn, 8, 0);	// USART6
HAL_NVIC_SetPriority(USART2_IRQn, 8, 0);	// USART2
HAL_NVIC_SetPriority(UART5_IRQn,  8, 0);	// UART5

HAL_NVIC_SetPriority(DMA1_Stream6_IRQn, 8, 0);  // DMA USART2 EXT2
HAL_NVIC_SetPriority(DMA1_Stream5_IRQn, 8, 0);  // DMA USART2
HAL_NVIC_SetPriority(DMA1_Stream7_IRQn, 8, 0);  // DMA USART5 EXT1
HAL_NVIC_SetPriority(DMA1_Stream0_IRQn, 8, 0);  // DMA USART5

HAL_NVIC_SetPriority(PendSV_IRQn, 15, 0);	// HAL_MspInit()
*******************************************************


=====================================================================
!!! доп. замечания от Мариуполя !!!!
1.При гибридном двухпроводном управлении ПЧ (один ключ пуск-стоп, дискретный вход 1 - пуск по фронту, дискретный вход 2- стоп по спаду, дискретный вход 1 и 2 запаралелены), при отключенном ключе пуск-стоп и подаче напряжения на ПЧ происходит его запуск (при включении эл.энергии после нештатного пропадания остановленный ПЧ запустится в работу).
2.Невозможно изменить настройку схемы управления (2-прододная, 3-проводная) без меню пошаговой настройки.
3.Необходимо сделать изменяемый режим установки текущего задания частоты от цифрового потенциометра после отключения ПЧ от сети (с сохранением предыдущего задания или без сохранения)
4.Статусное меню ПЧ малоинформативное, нет возможности одновременно видеть название параметра и его значение. Желательно иметь несколько вариантов отображения статусного меню (строчный и разбитый на несколько окон).
5.Добавить в статусное меню информацию о текущем режиме работы ПЧ.
6.Добавить в ПЧ функционал работы по таймеру.
=====================================================================
Аварийное откл контактора лифта
 278
 186A000 = 25600000
 
 -0.1 = 0188F000 - 25 751 552
  0.1 = 00004000 - 16384 
  600 = 6000000 = 100663296
  -600 = B893000 = 193540096 / 476D0000

-------------------------------------------------------------------------------------------------------
 

- Сделать АПВ по другому. Реализовать возможность задать 5 (или более) слотов для АПВ, в которые можно настроить любую аварию. Блоку АПВ по сути все равно с кем работать. НА вход подавать номер аварии с параметра текущей аварии и активировать выбранный блок при совпадении. Одного такта микропрограммы должно хватить. Тогда все будет значительно проще с АПВ.
НО! здесь есть нюанс, у меня не получится автоматически включать аварию для выбранной аварии АПВ. Придется разрабатывать алгоритм установки аварий в автоматическом режиме.
Необходимо перелопатить список аварий и выбрать те, для которых можно разрешить перезапуск - отдельный список аварий. И к ним блок, который для некоторых будет формировать автоустановку режима аварии для данной защиты! Для обрыва входных фаз, надо сделать особенную обработку по списку аварий. ДА и сам список надо сделать особым и фильтровать аварии внутри блока.

	Добавлен тестовый вариант для двух слотов АПВ. Надо проверить в железе и довести до ума. 
 
 
 ОТКАТИТЬ НОВОЕ АПВ!!!
------------------------------------------------------
блок фазирования энкодера


Входы
   Уставки
 - активировать фазирование энкодера
 - скорость движения при фазировании - 2 Гц, по умолчанию
   Net
 - Сигнал на контактор
 - ШИМ включен
 - Сигнал наличия аварии в системе
 - Текущая частота
 - Текущая частота ротора
 - Текущая фаза энкодера
 
Выходы
 - Сигнал что идет фазировка энкодера (он как раз и будет сигналом на подмену скорости) - передаем в LIFT_CMD + RAMP_CNTRL
 - Задание скорости в блок RAMP_CNTRLs
 - Фазирование закончено - будет сигналом остановки? передаем в LIFT_CMD
   Аварии
 - Таймаут - долго нет R метки (для абсолютных энкодеров)
 - Ошибка в скорости - возможно неправильно указаны номинальные параметры.
 - Внешний останов - прерывание фазировки
 - Неудержал кабину.
 
 
 Добавить ноги в LIFT_CMD - Фазирование энкодера и максимальный момент в лифте и уставки Удержание PMSM

ПРОВЕРКИ работы ПРИ ОТЛАДКЕ В ЖЕЛЕЗЕ
1. Преждевременное отключение ШИМа - норма (сим)
2. Нет R метки - норма (сим)
3. Ошибка скорости при фазировании скорости, то что я в зоне нужной скорости -  норма (сим)
4. Нужна проверка при прямом и обратном вращении - вверх и вниз. 
5. Падение кабины в момент снятия тормоза - норма (сим)

- проверить что в железе уставки будут нормально сохраняться при фазировке и не будет глюков.
- Проверить оба такта фазирования - норма (сим)
- надо оценить длительность отображения аварий фазировки - возможно потом поправить их время свечения в FAIL_COMMON_V2.


------------------------------------------------------
 падение на транзисторе 0,9... 1В
 падение на диоде 0,9... 1В
 Сопротивление ключа 16 мОм
 Ton = 0.054 us
 Toff = 0.335 us
------------------------------------------------------


 - Есть вопрос в этих строках:
#define cs_set()  FRAM_CS_MK_GPIO_Port->BSRR = (uint32_t)FRAM_CS_MK_Pin << 16U  
#define cs_reset() FRAM_CS_MK_GPIO_Port->BSRR = FRAM_CS_MK_Pin
   При управлении через BSRR - сброс выходного бита происходит в битах 31...16, а установка в битах 15...0. А в этих строках все наоборот
   В DrvSPI надо в коде менять местами cs_set и cs_reset, т.к. их перепутали местами!!!

 - Необходим вариант защиты, если вдруг значение частоты ШИМа станет выше допустимой частоты по такту ШИМа. Это надо сделать прямо в самом ядре управления. контролировать такт ШИМа и всегда форимровать максимальную частоту ШИМа как внешнее ограничение.
   Надо в два модуля InitVarPwm и PwmReInit добавить функцию ограничитель, которая будет сравнивать задание ШИМа и ограничивать. В структуру ШИМа надо установить два значения - минимальный ШИМ и максимальный. Минимальный забить дефайном, а максимальный в каждом такте ШИМа обновлять!!! Мало того, после ограничения частоты ШИМа надо скорректировать значение текущей частоты ШИМа, чтобы не поплыл логгер. И пора добавить параметр текущей частоты ШИМа, и тогда его подвязать под значение частоты ШИМа.

 - Стоит важный вопрос переницализации ШИМа - либо надо просто сделать переинициализацию в реальном времени с пропуском такта расчета, и не выносить его отдельно



 - При активации автоматического дерейтинга по ШИМ надо выводить предупреждение - что характеристики снижаются.

 - Необходимо реализовать отказ при работе с Modbus если запрос пришел к несуществующему параметру, даже в случае пакетного запроса


 - Надо реализовать возможность динамической смены списков назначений (например дискретов, реле) в зависимости от имеющихся блоков расширения. Механизм такой же как и при выборе функционала, но только от типа блока.

 - Добавить слово управления для привода, чтобы пуски можно было делать не только через 5-ю функцию. РАзместить в блоке CONTROL_V2, и оттуда выдавать все команды.
 
 - Надо в визард добавить проверку - если в мастере настройки не указан дискрет эвакуации (нет его среди функций дискретных сигналов), то можно и не выводить настройки эвакуации, включая параметр Эвакуция - Вкл/Выкл. Зачем они нужны пользователю в таком случае. Если выберет снова дискрет эвакуации - вернем уставки.

 - Ревизия РЭ на лифты. Надо сформировать грубую структуру меню РБВ, и добавить грубые мазки настройки.

 - Дополнительное сообщение при перегрузке ПЧ. Должна быть отдельная уставка уровня перегруза ПЧ - сколько мы допускаем его перегружать, причем это не должно быть связано с ограничение для двигателя.
 

 - Добавить параметр активации режима симуляции токов (вплоть по фазам) и напряжений (вход и ЗПТ) - Надо сделать более красиво. Пока только в первом варианте. Но еще нужна защита, что если вижу токи от двигателя, надо отключать данный режим симуляции.


 
 - НАДО СДЕЛАТЬ ОТКЛЮЧЕНИЙ АВАРИЙ для AIO2, КОГДА БЛОКА ФИЗИЧЕСКИ НЕТУ. а сдругой стороны блок сломался и мы упали в аварию. плохо что уставки не будут видны аварийно.
   А если в этой ситуации мы видим аварию по данным блокам, но блоков нет, то надо разрешить видеть доступ к этим авариям.

 - PB-M40? управление зарядом. - Надо добавить параметр 38-23 - Выбор силового блока: Автовыбор, PB24, Combo, PB24-M40. При идентификации типа силового блока анализировать 38-23. Если он в режиме Авто, работаем по сигналам с платы (аппаратная идентификация). Если есть фиксированный выбор - то работает по нему. И соответственно внести изменения по управлению зарядом в драйвер - DrvCharge_CP24B
 А ЧТО ПО ИЗМЕРЕНИЮ ВХОДНОГО НАПРЯЖЕНИЯ? В НОВОМ БЛОКЕ ТОЖЕ КАК В В ОБЫЧНОМ РВ24 ИЛИ КАК В КОМБО????
 ТЕМПЕРАТУРА???
 АВАРИЯ КЛЛЮЧЕЙ???
  
 - Если установлен был лифт, и есть переход в Насос через быструю настройку, то остается активной проверка ОС от контактора. Надо убрать - Не подтвердилось. В новой версии все ок.


 +- ДЛя восстановления уставок из старых версий, добавлена установка флага UstRecoveryFlag, чтобы при синхронизации FRAM данные не подтягивались. ПРОВЕРИТЬ работу!!! Все работает, но есть проблема. Теперь данные которые нормальные в FRAM обнудяются на даннные из уставок, и тем самым слетает UF и измеренные параметры двигателя!!! Так выходит что негодится!!! В UF там четко CRC не совпал, а впот при проверке данных двигателя - там было все ОК. Проблему решит перенос уставок в новом формате - импорт/экспорт. Данные двигателя можно подкрепить CRC и смотреть на него. ВОзможно с ним эьи данные не потеряются.
  
 - Заморозку регуляторов пока убрал
 
 - Надо проверить, почему при измерении Rs напряжение Urs переводится в s16, мы ж типа теряем знаки
 
 - Регулятор потока не хочет возбуждать движок на ШИМЕ 6 кГц. Провести тщательный анализ работы регулятора потока в разных условиях частоты ШИМа. Стабильность возбуждения.?!?!?

       
 - ПРи измерении температуры есть проблема. Неправильно учтены значения АЦП 1В и 2,5В. Сейчас расчет сделан для 3В опоры, а по факту у нас 3.3 опора.
 
 - После пуска ПЧ запросы по 485 приходят только после 3 запроса в ПЧ. Странно. Реально первый запрос не вызывает прерывание IDLE. Второй вызывает, но там по факту два пакета, и как результат CRC не совпадает. И только 3-й пакет принимается корректно!!! Хотя если ТехПО было уже подключено, и просто перезагрузить ПЧ, то стартует обмен сразу.

 - авторасчет коэф рег тока при смене ШИМа, вероятно он влияет на регулятор потока

 - Что меняю в параметрах и после перезашивки ПЧ уже два раза сбрасывались измеренные параметры двигателя!!!
 - Настройка Эзернета через пульт или вайфай.
 
 - Задать в уставку минусовой предел и посмотреть что я вычитаю из уставки при запуске. Есть общая проблема. ТехПО создает по своему минусовые уставки, Вайфай чуть лучше - отображается правильно в ТехПО, но при расчете неправильное значение в самом блоке. Когда ПЧ сам сохраняет уставки в польз. набор, то все нормально после восстановления. Во всех случаях разные значения в уставках. Надо понять в чем же разница и где правда !!!
 
 - СР24 RS2 - запись в файлы.
 - Реализовать просмотр отсчетов АЦП внутри DMA - как сделал Степанов.
 
 - Кварцы перед настройкой надо в явном виде тормозить и потом запускать повторно.
  
 - Зависла прошивка 168.51.1 когда я перешел на нее с версии 168.51.2 - уходим в Хардфаулт. ПОка не сбросил через прогер на Дефаулт, не хотела работать.
 
 - Сделать возможность переноса уставок из старых версий ПЧ в новые, путем копирования !!!! Реализовать вариант импорт/экспорт через дополнительную таблицу модбас. Вычитать все параметры и вкинуть в новый ПЧ. А в после переноса еще указать что не удалось восстановить.
 
 - НУЖЕН ПЕРЕВЫПУСК ЗАГРУЗЧИКА ДЛЯ СР24. ОШИБКА В НАСТРОЙКЕ ТАКТОВОГО ГЕНЕРАТОРА
 
- Входы переключения задания и управления, и UF надо расширить на входы с блока расширения. Но при его отсутствии выдавать предупреждение. Но как сделать это на этапе инициализации, пока я блок еще не определил??

- При выборе в назначении реле аварий с блоков расширения (напр. Авх3/4), тоже выдавать предупреждение если нет таких блоков.

- В окне вайфай где выбираем уставки которые будем смотреть в теках, тоже надо скрывать названия уставок, которые сейчас не видны (например, напряжение на входе)

- добавить в журнал канал пуска. 

- ВУ с ОС - почему скорость странно передается

- На блока ср24 v2.1 коммуникационные блоки не смогут работать, иначе они полностью отключат работу с флэшкой, т.к. ДМА всегда будет занят на приеме. Но можно мониторить кол-во байт на приеме в ДМА и если там 0 принятых данных, то отдавать запрос на Флэшку.
- Надо запуски основных потоков сделать через семафоры а не на задержках.


- При работе в лифтовом мастере изменение UF приводит к проблемам в работе. Лифт перестает стартовать - токи маленькие, ну и бывает мычит/рычит.

- Нужна доработка МКАР - он еще  может pt100 обрабатывать!!!

- RrEst1 = Unmot/sqrt(3) *snom / sqrt(Inmot^2 - (dPnt_Ixx/sqrt(2))^2)
  
- Надо синхронизировать старт таймера 5 и таймера ШИМ. Чтобы на новом периоде ШИМа таймер 5 стартовал с нуля счетчика.

- при измерении параметров в ручном режиме если не вовремя снять ОС контактора, то параметры не измеряться. Надо при измерении параметров как-то блокировать аварии контактора!!
- Журнал аварий - фиксировать входную сеть!!!
---------------------------------

- В Визарде при выборе режима Тормоз с ОС не хватает появления кнопки и проверки а выбрана ли ОС на дискрет! МОжно вывести кнопку с переходом на настройку дсикретов.

- Надо ногу PD3 активировать на прерывание и иммитировать аварийный стоп по аналогии с STO. ЕГо надо подвязать к элементу Аварийный стоп. И будет он работать во всех блоках

- Для АЦП токов хорошо бы буфер сделать пинг-понгом. ИСпользовать 2 буфера и по заполнению подсовывать новый. ВОзможно в прерывании ДМА , или двойной буфер
- после частоты 10 кГц надо уменьшать число отсчетов ацп, снизив до 8 отсчетов
- двойной расчет такта шима, при частотах шима ниже 3кГц, делать два расчета ВУ, на восходе, и на спаде, и вторично прогружать ARR до окончания периода ШИМа.

-+ !! Эвакуция, скаляр. - Надо проверять не на 0 активного тока, а на 10%. Если активный ток ниже 10% номинала, то надо ехать в ту же сторону. А также добавить буфер на 0,5 секунды, и брать во внимание данные с задержкой, иначе мгновенное значение может дать неправильный результат. 

- Прокинуть через схему сигнал активной эвакуации EVAC_ON, и заменить его глобальный аналог который сейчас временное решение.
- Замечено странное поведение в эвакуации при манипуляции направлениями вперед/назад. Бывает ситуация когда лифт в стопе а ШИМ работает.

- Сбрасывается АПВ если в момент счета приходит авария отключающая ВЫпрямитель!!! На обычные аварии такой реакции нету.

- Эмуляция энкодера - что-там, как там?!?!?!
- Возможно для STO надо ввести режим авариий. При разрыве всегда авария, или проверять по пуску, или еще что-то?

- Что вешает ШИМ в ВУ при неправильной инверсии токов. 
- Лифт, блоки расширений.
- Надо переделать сигналы от дискретных функций, да и вообще навести там порядок.
- переменная частота ШИМа  в работе (Не забыть про логгер, он не будет нормально работать с переменным ШИМом)
- Контроль резервного питания - DrvBackupPowerCont
- Плавный сброс тока - параметры выкинуть в систему !!!! Они в дебагах 
- Нужна фиксация состояния дискретных входов с блока расширения, и недопущение пуска когда они установлены при подаче питания. Но есть нюанс. Задержка перед началом опроса?!?!?
- нужна уставка по отображению текущего значения ШИМа при переменой частоте ШИМа.
- обратная связь по тормозу. Переделать алгоритм выбора режима Тормоза.

- проверить, а что будет если один из ДТ инверсный. Какой будет последовательность, фаза суммарная, нулевой ток 1 зак кирх??


- STO в Ср24 - он еще работает на ДИН7 или уже поламался, потому как его обработчик есть в FailControl
==========================================================================================================
- по какой-то причине ОС isd при переходе в ВУ рассчитывается с ошибкой. Есть неясный скачок из + в минус. ОЧЕНЬ ПОХОЖЕ, ЧТО ПРОБЛЕМА В РЕГУЛЯТОРЕ ПРОТИВОЭДС, КОГДА ЗАМЕНЯЮ ВЫХОД С ПЛАВНОГО ПУСКА НА ФИКСИРОВАННОЕ ВОЗБУЖДЕНИЕ, ТО СТАНОВИТСЯ ЛУЧШЕ. А ПРИ ВЫКЛЮЧЕННОМ ОСЛАБЛЕНИИ ПОЛЯ ВСЕ РАВНО НЕ ОЧЕНЬ. НАДО РАЗБИРАТЬСЯ.

- все равно нужна блокировка работы с Х_ХХ при частотах выше 100-300 Гц, вывод выходной частоты будет с проблемами
- Проверить работу самого фильтра скорости - есть вопросы к нему. МОжно ли убрать в нем условие vPrUP? Оно может нам мешать при переходе из подхвата. Нужен параметр на установку времени фильтрации задания КС. А то включалка фильтра есть, а время не поставить. ПОка в дебугах. Возможно из-зи него и не работал нормально подхват, т.к. время было нулевое.


!!! Время плавного сброса тока все еще висит в дебугах - нужен параметр.
Выбор по дискретному сигналу



	nvAdrCoef   = &nv.MicroProg; 		// 0
    	nvAdrCoef   = &nv.MemSignatura; 	// 0x2000
	nvAdrCoef   = &nv.MicroSignatura;	// 0x2002
	nvAdrCoef   = &nv.errImaxCnt;		// 0x2004
    	nvAdrCoef   = &nv.UstRecoveryFlag;	// 0x2006
	nvAdrCoef   = &nv.stopTime;		// 0x2008
	nvAdrCoef   = &nv.mtzTime;		// 0x200c
	nvAdrCoef   = &nv.mtzTimeSum;		// 0x2010
	nvAdrCoef   = &nv.file;			// 0x2014
	nvAdrCoef   = &nv.DK_file;		// 0x2a70
	nvAdrCoef   = &nv.UstModbusAdr;		// 0x2B9C
	nvAdrCoef   = &nv.trend_file;		// 0x3BA4	
	nvAdrCoef   = &nv.Space; 		// 0x6A84
	nvAdrCoef   = &nv.mtzTimeBuff;		// 0x7F28
	nvAdrCoef   = &nv.AOutput;		// 0x7F40
	nvAdrCoef   = &nv.AInput;		// 0x7F54
	nvAdrCoef   = &nv.adjCoefcnts;		// 0x7F9C
	nvAdrCoef   = &nv.nvEngineParam;	// 0x7FBC
	nvAdrCoef   = &nv.fileCurFunct;		// 0x7FF8
	nvAdrCoef   = &nv.fileCurFunctPrev;	// 0x7FFC
	nvAdrCoef   = &nv.EngineRunFlag;	// 0x8000
	nvAdrCoef   = &nv.PowerFailTime;	// 0x8004


32768 = 16384 * sizeof(u16);
8192 = sizeof(u16) * SZ_MICROPROG_DATA;
10 = sizeof(u16) * 5;
20 = sizeof(u32)*5;
2652 = sizeof(fram_file_type);
8 = sizeof(FileFunctional_type) * 2;
24 = sizeof(u32)*(MTZ_BUF_SIZE);
20 = sizeof(nvAoutCalState_type);
300 = sizeof(DK_file_type);
70 = sizeof(nvAinCalState_type );
32 = sizeof(nvAdjCoef_type);
12000 = sizeof(Trend_file_type);
60 = sizeof(nvEngineParam_type);
5278 = sizeof(Space_type);
4102 = sizeof(nvParamAdr_type);